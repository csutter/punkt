#!/usr/bin/env bash
set -xeo pipefail

# Install OSTree dependencies and reboot
podman machine ssh sudo rpm-ostree install cockpit-system cockpit-ostree cockpit-podman cockpit-pcp
podman machine ssh sudo systemctl reboot || true # SSH connection closing causes non-zero exit code

echo "Waiting a few moments for machine to reboot..."
sleep 15

# Disable Cockpit HTTPS redirection (to stop faffing around with self-signed certificates)
podman machine ssh sudo touch /etc/cockpit/cockpit.conf
podman machine ssh -- \
  'echo -e "[WebService]\nAllowUnencrypted = true" | sudo tee -a /etc/cockpit/cockpit.conf'

# Run Cockpit web service using podman (how meta!)
podman machine ssh sudo podman container runlabel --name cockpit-ws RUN docker.io/cockpit/ws
podman machine ssh 'sudo rm /etc/cockpit/ws-certs.d/0-self-signed*' || true # may not exist
podman machine ssh sudo podman container runlabel INSTALL docker.io/cockpit/ws
podman machine ssh sudo systemctl enable --now cockpit.service

# Allow password auth and set password for `core` user to be able to sign in
podman machine ssh 'echo "core" | sudo passwd core --stdin'
podman machine ssh -- \
  'echo "PasswordAuthentication yes" | sudo tee /etc/ssh/sshd_config.d/02-enable-passwords.conf'
podman machine ssh sudo systemctl try-restart sshd

# Set up port forwarding to localhost
#  c.f. https://github.com/containers/podman/issues/12073
curl http://localhost:7777/services/forwarder/expose \
     -X POST -d '{"local":":9090","remote":"192.168.127.2:9090"}'
